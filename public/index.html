
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Scholar AI - Ask Questions</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0d5d36">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d5d36;  /* Deep green */
            --secondary-color: #c5a455; /* Gold */
            --background-color: #f8f5ee; /* Cream */
            --dark-text: #333333;
            --light-text: #ffffff;
            --accent-color: #d4af37;  /* Another gold tone */
            --border-radius: 16px;
            --transition-speed: 300ms;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--background-color);
            color: var(--dark-text);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230d5d36' fill-opacity='0.03'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10S0 25.523 0 20s4.477-10 10-10zm10 8c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm40 40c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .container {
            max-width: 1000px;
            width: 90%;
            margin: 2rem auto;
            padding: 0;
            flex: 1;
        }
        
        header {
            text-align: center;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .bismillah {
            font-family: 'Amiri', serif;
            font-size: 3.5rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            text-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .title {
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), #083f25);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .subtitle {
            color: #555;
            font-size: 1.1rem;
            font-weight: 300;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .geometric-border {
            position: relative;
            height: 10px;
            width: 80%;
            margin: 15px auto;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='10' viewBox='0 0 60 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0 L5 10 L15 10 Z M25 0 L20 10 L30 10 Z M40 0 L35 10 L45 10 Z M55 0 L50 10 L60 10 Z' fill='%23c5a455' fill-opacity='0.3'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
        }
        
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 1.5rem;
            transition: all var(--transition-speed) ease-in-out;
            border: 1px solid rgba(13, 93, 54, 0.1);
        }
        
        .chat-header {
            padding: 1.2rem 1.5rem;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .chat-title svg {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
        
        .messages {
            padding: 1.5rem;
            height: 450px;
            overflow-y: auto;
            scroll-behavior: smooth;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%230d5d36' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .messages::-webkit-scrollbar-thumb {
            background: rgba(13, 93, 54, 0.3);
            border-radius: 10px;
        }
        
        .messages::-webkit-scrollbar-thumb:hover {
            background: rgba(13, 93, 54, 0.5);
        }
        
        .chat-bubble {
            max-width: 80%;
            padding: 1rem 1.2rem;
            border-radius: 18px;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
            position: relative;
            animation: fadeIn 0.4s ease-in-out;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--primary-color), #083f25);
            color: var(--light-text);
            margin-left: auto;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(13, 93, 54, 0.2);
        }
        
        .bot-message {
            background: #f8f9fa;
            border-bottom-left-radius: 4px;
            color: var(--dark-text);
            border-left: 3px solid var(--secondary-color);
            position: relative;
        }
        
        .bot-avatar {
            position: absolute;
            left: -36px;
            bottom: 0;
            width: 28px;
            height: 28px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bot-avatar svg {
            width: 18px;
            height: 18px;
            fill: white;
        }
        
        .message-controls {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            justify-content: flex-end;
        }
        
        .tts-button {
            background: none;
            border: none;
            color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            padding: 5px 8px;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .tts-button:hover {
            color: var(--primary-color);
            background: rgba(13, 93, 54, 0.1);
        }
        
        .tts-button.playing {
            color: var(--primary-color);
            background: rgba(13, 93, 54, 0.1);
        }
        
        .tts-button svg {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }
        
        .input-container {
            display: flex;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            align-items: center;
        }
        
        #user-input {
            flex: 1;
            padding: 0.9rem 1.2rem;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 30px;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95rem;
            background: white;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            min-height: 48px;
        }
        
        #user-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 2px 12px rgba(13, 93, 54, 0.15);
        }
        
        #send-btn {
            background: linear-gradient(135deg, var(--primary-color), #083f25);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin-left: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(13, 93, 54, 0.2);
        }
        
        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 93, 54, 0.3);
        }
        
        #send-btn:active {
            transform: translateY(0);
        }
        
        #send-btn svg {
            width: 22px;
            height: 22px;
        }
        
        .loading {
            display: none;
            justify-content: flex-start;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .loading-dots {
            display: flex;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            margin: 0 3px;
            background-color: var(--primary-color);
            border-radius: 50%;
            opacity: 0.5;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .arabic {
            font-family: 'Amiri', serif;
            direction: rtl;
            line-height: 1.8;
            margin: 10px 0;
            font-size: 1.1rem;
            background: rgba(197, 164, 85, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-right: 3px solid var(--secondary-color);
        }
        
        .verse-reference {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            font-style: italic;
            margin-top: 5px;
        }
        
        .quran-box {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            background-color: rgba(197, 164, 85, 0.05);
        }
        
        .section-header {
            color: var(--primary-color);
            margin: 16px 0 8px;
            font-weight: 600;
            border-bottom: 2px solid var(--secondary-color);
            display: inline-block;
            padding-bottom: 3px;
        }
        
        .scholar-note {
            background-color: rgba(13, 93, 54, 0.05);
            border-left: 3px solid var(--primary-color);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .footnote {
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .footnote svg {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }
        
        .quick-action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-action {
            background: rgba(13, 93, 54, 0.05);
            border: 1px solid rgba(13, 93, 54, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            color: var(--primary-color);
        }
        
        .quick-action:hover {
            background: rgba(13, 93, 54, 0.1);
            transform: translateY(-1px);
        }
        
        .prayer-times {
            background: linear-gradient(135deg, rgba(13, 93, 54, 0.92), rgba(8, 63, 37, 0.94));
            color: white;
            padding: 15px 20px;
            border-radius: calc(var(--border-radius) + 4px);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(197, 164, 85, 0.2);
            overflow: hidden;
        }
        
        .prayer-times::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color), transparent);
        }
        
        .prayer-times .location-info {
            font-size: 0.85rem;
            margin-top: 12px;
            opacity: 0.9;
            text-align: center;
            font-style: italic;
            background: rgba(255, 255, 255, 0.08);
            padding: 5px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .prayer-times-row {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
            margin-top: 5px;
        }
        
        .prayer-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            min-width: 80px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .prayer-time:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.18);
        }
        
        .prayer-time::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--secondary-color);
            transform: scaleX(0.3);
            transform-origin: center;
            transition: transform 0.3s ease;
        }
        
        .prayer-time:hover::after {
            transform: scaleX(0.8);
        }
        
        .prayer-name {
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-weight: 500;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.85);
        }
        
        .prayer-hour {
            font-weight: 600;
            font-size: 1rem;
            color: var(--secondary-color);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                margin: 1rem auto;
                padding: 0;
            }
            
            .title {
                font-size: 2.2rem;
            }
            
            .bismillah {
                font-size: 2.8rem;
            }
            
            .chat-bubble {
                max-width: 85%;
            }
            
            .messages {
                height: 400px;
                padding: 1.2rem;
            }
            
            .prayer-times {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .title {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            .bismillah {
                font-size: 2.2rem;
            }
            
            .chat-bubble {
                max-width: 90%;
                padding: 0.9rem 1rem;
            }
            
            .messages {
                height: 350px;
                padding: 1rem;
            }
            
            #user-input {
                padding: 0.7rem 1rem;
            }
            
            #send-btn {
                width: 42px;
                height: 42px;
            }
            
            .input-container {
                padding: 0.8rem 1rem;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #1a1e22;
                --dark-text: #e4e6eb;
            }
            
            body {
                background-color: var(--background-color);
                color: var(--dark-text);
            }
            
            .chat-container {
                background: rgba(30, 35, 40, 0.95);
            }
            
            .bot-message {
                background: #2a2f36;
                color: #e4e6eb;
            }
            
            #user-input {
                background: #2a2f36;
                color: #e4e6eb;
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .input-container {
                background-color: rgba(30, 35, 40, 0.8);
            }
            
            .subtitle {
                color: #b0b3b8;
            }
            
            .arabic {
                background: rgba(197, 164, 85, 0.15);
            }
            
            .quran-box {
                background-color: rgba(197, 164, 85, 0.08);
            }
            
            .scholar-note {
                background-color: rgba(13, 93, 54, 0.15);
            }
            
            .footnote {
                color: rgba(255, 255, 255, 0.5);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="bismillah">﷽</div>
            <h1 class="title">Islamic Scholar AI</h1>
            <p class="subtitle">Ask your questions about Islam and receive authentic answers based on Quran and Hadith</p>
            <div class="geometric-border"></div>
        </header>

        <div class="prayer-times">
            <div class="prayer-times-row">
                <div class="prayer-time">
                    <span class="prayer-name">Fajr</span>
                    <span class="prayer-hour" id="fajr-time">--:--</span>
                </div>
                <div class="prayer-time">
                    <span class="prayer-name">Dhuhr</span>
                    <span class="prayer-hour" id="dhuhr-time">--:--</span>
                </div>
                <div class="prayer-time">
                    <span class="prayer-name">Asr</span>
                    <span class="prayer-hour" id="asr-time">--:--</span>
                </div>
                <div class="prayer-time">
                    <span class="prayer-name">Maghrib</span>
                    <span class="prayer-hour" id="maghrib-time">--:--</span>
                </div>
                <div class="prayer-time">
                    <span class="prayer-name">Isha</span>
                    <span class="prayer-hour" id="isha-time">--:--</span>
                </div>
            </div>
            <!-- Location info will be added here dynamically -->
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0-18 0"></path>
                        <path d="M12 8v8"></path>
                        <path d="M8.5 14a2 2 0 1 0 0-4a2 2 0 0 0 0 4"></path>
                        <path d="M15.5 14a2 2 0 1 0 0-4a2 2 0 0 0 0 4"></path>
                    </svg>
                    Islamic Knowledge Assistant
                </div>
            </div>
            <div id="chat-container" class="messages"></div>
            <div id="loading" class="loading">
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Ask your Islamic question...">
                <button id="send-btn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="footnote">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
            </svg>
            Answers are provided based on Quran and authentic Hadith sources
        </div>
        <div class="footnote" style="opacity: 0.6; font-size: 0.8rem; margin-top: 0.5rem;">
            والله أعلم (Allah knows best)
        </div>
    </div>

    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
            });
        }
        
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loading = document.getElementById('loading');
        let currentlySpeaking = null;
        let availableVoices = [];

        // Prayer times based on user's location
        async function updatePrayerTimes() {
            try {
                // First get user's location (coordinates)
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    // Use Aladhan API to get prayer times for this location
                    const date = new Date();
                    const response = await fetch(`https://api.aladhan.com/v1/timings/${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}?latitude=${latitude}&longitude=${longitude}&method=2`);
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch prayer times');
                    }
                    
                    const data = await response.json();
                    const timings = data.data.timings;
                    
                    // Update the prayer times in the UI
                    document.getElementById('fajr-time').textContent = timings.Fajr;
                    document.getElementById('dhuhr-time').textContent = timings.Dhuhr;
                    document.getElementById('asr-time').textContent = timings.Asr;
                    document.getElementById('maghrib-time').textContent = timings.Maghrib;
                    document.getElementById('isha-time').textContent = timings.Isha;
                    
                    // Add a loading indicator while getting times
                    const prayerTimesElement = document.querySelector('.prayer-times');
                    prayerTimesElement.classList.add('loaded');
                }, 
                (error) => {
                    console.error('Geolocation error:', error);
                    fallbackToPrayerTimesAPI();
                },
                { timeout: 10000 });
            } catch (error) {
                console.error('Error fetching prayer times:', error);
                fallbackToPrayerTimesAPI();
            }
        }
        
        // Fallback method if geolocation fails - try to get location by IP
        async function fallbackToPrayerTimesAPI() {
            try {
                // First try to get user's location by IP
                const ipResponse = await fetch('https://ipapi.co/json/');
                const locationData = await ipResponse.json();
                
                // Use the city and country information to fetch prayer times
                const date = new Date();
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity/${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}?city=${locationData.city}&country=${locationData.country_name}&method=2`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch prayer times');
                }
                
                const data = await response.json();
                const timings = data.data.timings;
                
                // Update the prayer times in the UI
                document.getElementById('fajr-time').textContent = timings.Fajr;
                document.getElementById('dhuhr-time').textContent = timings.Dhuhr;
                document.getElementById('asr-time').textContent = timings.Asr;
                document.getElementById('maghrib-time').textContent = timings.Maghrib;
                document.getElementById('isha-time').textContent = timings.Isha;
                
                // Add the location name to show user where the times are for
                const locationElement = document.createElement('div');
                locationElement.className = 'location-info';
                locationElement.textContent = `${locationData.city}, ${locationData.country_name}`;
                document.querySelector('.prayer-times').appendChild(locationElement);
            } catch (error) {
                console.error('Fallback location error:', error);
                // If all else fails, show default times
                showDefaultPrayerTimes();
            }
        }
        
        // Show default times as last resort
        function showDefaultPrayerTimes() {
            document.getElementById('fajr-time').textContent = '05:12';
            document.getElementById('dhuhr-time').textContent = '12:30';
            document.getElementById('asr-time').textContent = '15:45';
            document.getElementById('maghrib-time').textContent = '18:10';
            document.getElementById('isha-time').textContent = '19:40';
        }
        
        // Call function to update prayer times
        updatePrayerTimes();

        // Load available voices for TTS
        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        loadVoices();

        // Helper function to create bot avatar element
        function createBotAvatar() {
            const avatar = document.createElement('div');
            avatar.className = 'bot-avatar';
            avatar.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                    <path d="M337.782 434.704l-73.755 73.754 73.755 73.755c0 0 169.84-42.6 169.84-286.2S388.443 0 256.016 0 4.683 170.008 4.683 296.012s169.84 286.19 169.84 286.19l73.754-73.754-73.784-73.744H337.79z"/>
                </svg>
            `;
            return avatar;
        }

        // Add message to chat
        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isUser ? 'user-message' : 'bot-message'}`;
            
            // Format the message with proper HTML
            const formattedMessage = formatBotMessage(message);
            messageDiv.innerHTML = formattedMessage;
            
            // If it's a bot message, add bot avatar and TTS button
            if (!isUser) {
                const botAvatar = createBotAvatar();
                messageDiv.appendChild(botAvatar);
                
                // Add controls
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'message-controls';
                
                const ttsButton = document.createElement('button');
                ttsButton.className = 'tts-button';
                ttsButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    </svg>
                    Listen
                `;
                
                ttsButton.addEventListener('click', () => {
                    // Stop any currently playing speech
                    if (currentlySpeaking) {
                        speechSynthesis.cancel();
                        document.querySelectorAll('.tts-button').forEach(btn => {
                            btn.classList.remove('playing');
                            btn.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                </svg>
                                Listen
                            `;
                        });
                        currentlySpeaking = null;
                        return;
                    }
                    
                    // Update button state
                    ttsButton.classList.add('playing');
                    ttsButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                        Stop
                    `;
                    
                    // Clean the text for speech (remove HTML tags)
                    const textToSpeak = message.replace(/<[^>]*>/g, '');
                    
                    const speech = new SpeechSynthesisUtterance(textToSpeak);
                    speech.lang = 'en-US';
                    
                    // Try to find a deep male voice suitable for an Islamic scholar
                    availableVoices = speechSynthesis.getVoices();
                    const preferredVoices = [
                        'Google UK English Male',
                        'Microsoft David - English (United States)',
                        'Microsoft Mark - English (United States)',
                        'Daniel',
                        'Google US English',
                        'Arabic Male'
                    ];
                    
                    for (const preferredVoice of preferredVoices) {
                        const voice = availableVoices.find(v => v.name === preferredVoice);
                        if (voice) {
                            speech.voice = voice;
                            break;
                        }
                    }
                    
                    // Use lower pitch for a deeper voice
                    speech.rate = 0.9;  // Slightly slower rate for clarity
                    speech.pitch = 0.8; // Lower pitch for a deeper voice
                    
                    speechSynthesis.speak(speech);
                    currentlySpeaking = speech;
                    
                    speech.onend = () => {
                        currentlySpeaking = null;
                        ttsButton.classList.remove('playing');
                        ttsButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                            </svg>
                            Listen
                        `;
                    };
                });
                
                controlsDiv.appendChild(ttsButton);
                messageDiv.appendChild(controlsDiv);
                
                // Add quick action buttons for related questions
                addQuickActionButtons(messageDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Format bot message with special styling
        function formatBotMessage(message) {
            // Replace Arabic verses with proper styling
            let formatted = message;
            
            // Detect Arabic text and add proper styling
            formatted = formatted.replace(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/g, match => {
                return `<div class="arabic">${match}</div>`;
            });
            
            // Add section headers styling
            formatted = formatted.replace(/^(#+\s+.+)$/gm, match => {
                const headerText = match.replace(/^#+\s+/, '');
                return `<div class="section-header">${headerText}</div>`;
            });
            
            // Replace Quran references with proper formatting
            const quranVerseRegex = /\(Quran\s+(\d+):(\d+)\)/g;
            formatted = formatted.replace(quranVerseRegex, match => {
                return `<div class="verse-reference">${match}</div>`;
            });
            
            // Handle bold text formatting (using both ** and __ Markdown styles)
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Format bullet points
            formatted = formatted.replace(/^(\s*)-\s+(.+)$/gm, '<span>⦿ $2</span>');
            
            // Replace newlines with <br>
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
        
        // Add quick action buttons for related questions
        function addQuickActionButtons(messageDiv) {
            // Sample related questions - in a real app, these would be dynamically generated
            const relatedQuestions = [
                "How to pray Salah?",
                "What is Tawheed?",
                "Fasting in Ramadan",
                "Hajj requirements"
            ];
            
            // Only add buttons to some messages (for demonstration)
            if (Math.random() > 0.5) {
                const quickActionDiv = document.createElement('div');
                quickActionDiv.className = 'quick-action-buttons';
                
                relatedQuestions.forEach(question => {
                    const button = document.createElement('button');
                    button.className = 'quick-action';
                    button.textContent = question;
                    
                    button.addEventListener('click', () => {
                        userInput.value = question;
                        handleSend();
                    });
                    
                    quickActionDiv.appendChild(button);
                });
                
                messageDiv.appendChild(quickActionDiv);
            }
        }

        // Handle sending a message
        async function handleSend() {
            const question = userInput.value.trim();
            if (!question) return;

            // Add user message
            addMessage(question, true);
            userInput.value = '';
            
            // Show loading animation
            loading.style.display = 'flex';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: question })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                
                // Hide loading animation
                loading.style.display = 'none';
                
                // Add bot response
                addMessage(data.reply);
            } catch (error) {
                loading.style.display = 'none';
                addMessage('Could not get response. Please try again later.');
            }
        }

        // Welcome message
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                addMessage("بسم الله الرحمن الرحيم\n\nAssalamu Alaikum! I'm your Islamic Scholar Assistant. Feel free to ask me any questions about Islam, and I'll provide answers based on the Quran and authentic Hadith sources.\n\nHow may I assist you today?");
            }, 500);
        });

        // Event listeners
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });
        
        // Debounce function for input typing feedback
        function debounce(func, delay) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        
        // Add typing indicator when user is typing
        userInput.addEventListener('input', debounce(() => {
            // Here you could implement typing indicator if needed
        }, 200));
    </script>
</body>
</html>
